name: Run Fixate With SARIF Output

on:
  workflow_dispatch:
  # push:
  #   branches: [ master ]
  # pull_request:
  #   branches: [ master ]

jobs:
  test:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Set up JDK
      uses: actions/setup-java@v4
      with:
        java-version: '8'
        distribution: 'zulu'

    - name: Download agent from GitHub Packages
      env:
        AGENT_VERSION: "1.3.1"
      run: |
        # Download agent
        curl -u "${{ github.actor }}:${{ secrets.GH_PACKAGES_READ_TOKEN }}" \
          -fL "https://maven.pkg.github.com/fixate-dev/Fixate/com/example/fixate-agent/${AGENT_VERSION}/fixate-agent-${AGENT_VERSION}.jar" \
          -o fixate-agent.jar

        jar tf fixate-agent.jar

    - name: Run tests with agent
      run: |
         mvn test -DargLine="-javaagent:/$(pwd)/fixate-agent.jar -Xmx16g"

    - name: Convert json report to sarif
      run: |
        # Take converter out of jar
        jar xf fixate-agent.jar fixate_report_to_sarif_converter.py
        
        # Generate Sarif file
        pip install typer
        python fixate_report_to_sarif_converter.py --find --out sarif-report.sarif

    - name: Upload SARIF file
      uses: github/codeql-action/upload-sarif@v3
      with:
        sarif_file: sarif-report.sarif

    - name: Upload test results
      uses: actions/upload-artifact@v4
      if: always()
      with:
        name: test-results
        path: "."
